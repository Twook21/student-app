// This is your Prisma schema file

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum Role {
  SUPERADMIN
  BK
  WALIKELAS
  GURUMAPEL
  SISWA
  ORANGTUA
}

enum StatusApproval {
  MENUNGGU
  DISETUJUI
  DITOLAK
}

enum TipeKategori {
  PELANGGARAN
  PRESTASI
}

model User {
  id        String   @id @default(uuid())
  name      String
  email     String   @unique
  password  String
  role      Role
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  siswaUser          Siswa?        @relation("SiswaUser")
  siswaAsOrangTua    Siswa[]       @relation("OrangTua")
  siswaAsWaliKelas   Siswa[]       @relation("WaliKelas")
  pelanggaranInput   Pelanggaran[] @relation("GuruInput")
  prestasiInput      Prestasi[]    @relation("GuruInput")
  notifikasiPenerima Notifikasi[]  @relation("Penerima")

  @@map("users")
}

model Siswa {
  id           String   @id @default(uuid())
  nama         String
  nis          String   @unique
  kelas        String
  totalPoin    Int      @default(0)
  orangTuaId   String?
  waliKelasId  String?
  userId       String?  @unique // Akun login untuk siswa
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  // Relations
  user         User?         @relation("SiswaUser", fields: [userId], references: [id])
  orangTua     User?         @relation("OrangTua", fields: [orangTuaId], references: [id])
  waliKelas    User?         @relation("WaliKelas", fields: [waliKelasId], references: [id])
  pelanggaran  Pelanggaran[]
  prestasi     Prestasi[]

  @@map("siswa")
}

model Kategori {
  id          String        @id @default(uuid())
  nama        String
  tipe        TipeKategori
  poinDefault Int
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt

  // Relations
  pelanggaran Pelanggaran[]
  prestasi    Prestasi[]

  @@map("kategori")
}

model Pelanggaran {
  id          String         @id @default(uuid())
  siswaId     String
  guruId      String
  kategoriId  String
  deskripsi   String         @db.Text
  poin        Int
  status      StatusApproval @default(MENUNGGU)
  alasanSiswa String?        @db.Text
  catatanBK   String?        @db.Text
  tanggal     DateTime       @default(now())
  createdAt   DateTime       @default(now())
  updatedAt   DateTime       @updatedAt

  // Relations
  siswa    Siswa    @relation(fields: [siswaId], references: [id], onDelete: Cascade)
  guru     User     @relation("GuruInput", fields: [guruId], references: [id])
  kategori Kategori @relation(fields: [kategoriId], references: [id])

  @@map("pelanggaran")
}

model Prestasi {
  id         String         @id @default(uuid())
  siswaId    String
  guruId     String
  kategoriId String
  deskripsi  String         @db.Text
  poin       Int
  status     StatusApproval @default(MENUNGGU)
  catatanBK  String?        @db.Text
  tanggal    DateTime       @default(now())
  createdAt  DateTime       @default(now())
  updatedAt  DateTime       @updatedAt

  // Relations
  siswa    Siswa    @relation(fields: [siswaId], references: [id], onDelete: Cascade)
  guru     User     @relation("GuruInput", fields: [guruId], references: [id])
  kategori Kategori @relation(fields: [kategoriId], references: [id])

  @@map("prestasi")
}

model Notifikasi {
  id        String   @id @default(uuid())
  userId    String
  title     String
  message   String   @db.Text
  isRead    Boolean  @default(false)
  createdAt DateTime @default(now())

  // Relations
  user User @relation("Penerima", fields: [userId], references: [id], onDelete: Cascade)

  @@map("notifikasi")
}

model AuditLog {
  id          String   @id @default(uuid())
  userId      String
  action      String   // CREATE, UPDATE, DELETE, APPROVE, REJECT, APPEAL
  entity      String   // SISWA, PELANGGARAN, PRESTASI, USER, etc
  entityId    String
  description String   @db.Text
  metadata    String?  @db.Text // JSON string for additional data
  createdAt   DateTime @default(now())

  @@map("audit_logs")
}